// Claude Context - Prisma Schema
// @prompt-id forge-v4.1:schema:context:001
// @generated-at 2026-01-22T00:00:00Z
// @model claude-opus-4-5

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DATABASE_DIRECT_URL")
  extensions = [pgvector(map: "vector"), uuid_ossp(map: "uuid-ossp")]
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

model Tenant {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name      String   @db.VarChar(255)
  slug      String   @unique @db.VarChar(100)
  plan      Plan     @default(FREE)
  settings  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users          User[]
  workspaces     Workspace[]
  contextGraphs  ContextGraph[]
  slices         Slice[]
  aiSessions     AISession[]
  integrations   Integration[]

  @@map("tenants")
}

enum Plan {
  FREE
  PRO
  TEAM
  ENTERPRISE
}

model User {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  email     String   @db.VarChar(255)
  name      String   @db.VarChar(255)
  avatarUrl String?  @map("avatar_url") @db.VarChar(500)
  role      UserRole @default(MEMBER)
  settings  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Auth fields
  passwordHash String?  @map("password_hash") @db.VarChar(255)
  mfaEnabled   Boolean  @default(false) @map("mfa_enabled")
  mfaSecret    String?  @map("mfa_secret") @db.VarChar(255)

  // Relations
  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workspaceMembers     WorkspaceMember[]
  createdSlices        Slice[]            @relation("SliceCreator")
  ownedSlices          Slice[]            @relation("SliceOwner")
  sliceReviews         SliceReview[]
  aiSessions           AISession[]
  sessionFeedback      SessionFeedback[]
  createdContextNodes  ContextNode[]
  apiKeys              ApiKey[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============================================================================
// WORKSPACE
// ============================================================================

model Workspace {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String   @db.VarChar(255)
  slug        String   @db.VarChar(100)
  description String?  @db.Text
  settings    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members       WorkspaceMember[]
  contextGraphs ContextGraph[]
  slices        Slice[]
  aiSessions    AISession[]
  integrations  Integration[]
  metrics       FeedbackMetrics[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("workspaces")
}

model WorkspaceMember {
  id          String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  workspaceId String              @map("workspace_id") @db.Uuid
  userId      String              @map("user_id") @db.Uuid
  role        WorkspaceMemberRole @default(MEMBER)
  createdAt   DateTime            @default(now()) @map("created_at")

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@map("workspace_members")
}

enum WorkspaceMemberRole {
  ADMIN
  MEMBER
  VIEWER
}

// ============================================================================
// CONTEXT GRAPH
// ============================================================================

model ContextGraph {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  name        String   @db.VarChar(255)
  description String?  @db.Text
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Version tracking
  version       Int      @default(1)
  globalVersion BigInt   @default(0) @map("global_version")
  createdById   String?  @map("created_by_id") @db.Uuid
  updatedById   String?  @map("updated_by_id") @db.Uuid

  // Relations
  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workspace Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  nodes     ContextNode[]
  edges     ContextEdge[]
  events    ContextEvent[]

  @@index([tenantId])
  @@index([workspaceId])
  @@index([tenantId, version])
  @@map("context_graphs")
}

model ContextNode {
  id          String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String           @map("tenant_id") @db.Uuid
  graphId     String           @map("graph_id") @db.Uuid
  type        ContextNodeType
  layer       ContextLayer
  name        String           @db.VarChar(255)
  content     String?          @db.Text
  /// @pii - May contain user-generated content
  metadata    Json             @default("{}")

  // Vector embedding for semantic search (1536 dimensions for OpenAI ada-002)
  embedding   Unsupported("vector(1536)")?

  // Freshness tracking
  freshness   Freshness        @default(CURRENT)
  validatedAt DateTime?        @map("validated_at")

  // External source tracking
  externalUrl    String?   @map("external_url") @db.VarChar(2000)
  externalId     String?   @map("external_id") @db.VarChar(255)
  externalSyncAt DateTime? @map("external_sync_at")

  // Token count for budget optimization
  tokenCount Int @default(0) @map("token_count")

  // Version tracking
  version     Int      @default(1)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String?  @map("created_by_id") @db.Uuid
  updatedById String?  @map("updated_by_id") @db.Uuid

  // Soft delete support
  deletedAt   DateTime? @map("deleted_at")
  deletedById String?   @map("deleted_by_id") @db.Uuid

  // Relations
  graph         ContextGraph  @relation(fields: [graphId], references: [id], onDelete: Cascade)
  createdBy     User?         @relation(fields: [createdById], references: [id])
  outgoingEdges ContextEdge[] @relation("SourceNode")
  incomingEdges ContextEdge[] @relation("TargetNode")
  sliceContexts SliceContext[]

  @@index([tenantId])
  @@index([graphId])
  @@index([type])
  @@index([layer])
  @@index([freshness])
  @@index([tenantId, version])
  @@index([deletedAt])
  @@map("context_nodes")
}

enum ContextNodeType {
  DOCUMENT
  DECISION
  PATTERN
  EXTERNAL_LINK
}

enum ContextLayer {
  ORGANIZATIONAL
  WORKSPACE
  SLICE
}

enum Freshness {
  CURRENT
  STALE
  ARCHIVED
}

model ContextEdge {
  id               String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId         String       @map("tenant_id") @db.Uuid
  graphId          String       @map("graph_id") @db.Uuid
  sourceNodeId     String       @map("source_node_id") @db.Uuid
  targetNodeId     String       @map("target_node_id") @db.Uuid
  relationshipType EdgeType     @map("relationship_type")
  metadata         Json         @default("{}")
  createdAt        DateTime     @default(now()) @map("created_at")

  // Relations
  graph      ContextGraph @relation(fields: [graphId], references: [id], onDelete: Cascade)
  sourceNode ContextNode  @relation("SourceNode", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode ContextNode  @relation("TargetNode", fields: [targetNodeId], references: [id], onDelete: Cascade)

  @@index([graphId])
  @@index([sourceNodeId])
  @@index([targetNodeId])
  @@map("context_edges")
}

enum EdgeType {
  REFERENCES
  IMPLEMENTS
  CONSTRAINS
  DEPENDS_ON
  SUPERSEDES
}

// ============================================================================
// SLICES (Work Units)
// ============================================================================

model Slice {
  id          String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String      @map("tenant_id") @db.Uuid
  workspaceId String      @map("workspace_id") @db.Uuid

  // Identifiers
  shortId     String      @map("short_id") @db.VarChar(20) // e.g., "SL-2847"
  name        String      @db.VarChar(255)

  // Core content
  outcome     String      @db.Text // Outcome statement
  antiScope   String[]    @map("anti_scope") // Explicitly excluded items

  // State machine
  status      SliceStatus @default(PENDING)

  // Ownership
  ownerId     String      @map("owner_id") @db.Uuid
  createdById String      @map("created_by_id") @db.Uuid

  // Timestamps
  startedAt   DateTime?   @map("started_at")
  submittedAt DateTime?   @map("submitted_at")
  completedAt DateTime?   @map("completed_at")
  archivedAt  DateTime?   @map("archived_at")

  // Version tracking
  version     Int         @default(1)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  updatedById String?     @map("updated_by_id") @db.Uuid

  // Soft delete support
  deletedAt   DateTime?   @map("deleted_at")
  deletedById String?     @map("deleted_by_id") @db.Uuid

  // Relations
  tenant             Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workspace          Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  owner              User                 @relation("SliceOwner", fields: [ownerId], references: [id])
  createdBy          User                 @relation("SliceCreator", fields: [createdById], references: [id])
  constraints        SliceConstraint[]
  acceptanceCriteria AcceptanceCriterion[]
  contextPackage     SliceContext[]
  transitions        SliceTransition[]
  reviews            SliceReview[]
  aiSessions         AISession[]

  @@unique([tenantId, shortId])
  @@index([tenantId])
  @@index([workspaceId])
  @@index([status])
  @@index([ownerId])
  @@index([tenantId, version])
  @@index([deletedAt])
  @@map("slices")
}

enum SliceStatus {
  PENDING
  ACTIVE
  IN_REVIEW
  COMPLETED
  ARCHIVED
}

model SliceConstraint {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sliceId   String   @map("slice_id") @db.Uuid
  content   String   @db.Text
  orderIndex Int     @default(0) @map("order_index")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  slice Slice @relation(fields: [sliceId], references: [id], onDelete: Cascade)

  @@index([sliceId])
  @@map("slice_constraints")
}

model AcceptanceCriterion {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sliceId     String   @map("slice_id") @db.Uuid
  content     String   @db.Text
  isCompleted Boolean  @default(false) @map("is_completed")
  completedAt DateTime? @map("completed_at")
  orderIndex  Int      @default(0) @map("order_index")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  slice Slice @relation(fields: [sliceId], references: [id], onDelete: Cascade)

  @@index([sliceId])
  @@map("acceptance_criteria")
}

model SliceContext {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sliceId   String   @map("slice_id") @db.Uuid
  nodeId    String   @map("node_id") @db.Uuid
  isPinned  Boolean  @default(false) @map("is_pinned")
  addedAt   DateTime @default(now()) @map("added_at")

  // Relations
  slice Slice       @relation(fields: [sliceId], references: [id], onDelete: Cascade)
  node  ContextNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([sliceId, nodeId])
  @@map("slice_context")
}

model SliceTransition {
  id         String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String       @map("tenant_id") @db.Uuid
  sliceId    String       @map("slice_id") @db.Uuid
  fromStatus SliceStatus? @map("from_status")
  toStatus   SliceStatus  @map("to_status")
  event      String       @db.VarChar(50)
  actorId    String       @map("actor_id") @db.Uuid
  comment    String?      @db.Text
  createdAt  DateTime     @default(now()) @map("created_at")

  // Relations
  slice Slice @relation(fields: [sliceId], references: [id], onDelete: Cascade)

  @@index([sliceId])
  @@index([tenantId])
  @@map("slice_transitions")
}

model SliceReview {
  id         String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sliceId    String        @map("slice_id") @db.Uuid
  reviewerId String        @map("reviewer_id") @db.Uuid
  verdict    ReviewVerdict
  comment    String?       @db.Text
  createdAt  DateTime      @default(now()) @map("created_at")

  // Relations
  slice    Slice @relation(fields: [sliceId], references: [id], onDelete: Cascade)
  reviewer User  @relation(fields: [reviewerId], references: [id])

  @@index([sliceId])
  @@map("slice_reviews")
}

enum ReviewVerdict {
  APPROVED
  CHANGES_REQUESTED
  REJECTED
}

// ============================================================================
// AI SESSIONS & FEEDBACK
// ============================================================================

model AISession {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  sliceId     String?  @map("slice_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid

  // Context snapshot
  contextNodeIds  String[] @map("context_node_ids") @db.Uuid
  contextTokenCount Int    @map("context_token_count")
  contextCompiledAt DateTime @map("context_compiled_at")

  // Session timing
  startedAt DateTime  @map("started_at")
  endedAt   DateTime? @map("ended_at")

  // Query hash for privacy
  queryHash String? @map("query_hash") @db.VarChar(64)

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workspace Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  slice     Slice?            @relation(fields: [sliceId], references: [id])
  user      User              @relation(fields: [userId], references: [id])
  feedback  SessionFeedback?

  @@index([tenantId])
  @@index([workspaceId])
  @@index([sliceId])
  @@index([userId])
  @@index([startedAt])
  @@map("ai_sessions")
}

model SessionFeedback {
  id        String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId  String        @map("tenant_id") @db.Uuid
  sessionId String        @unique @map("session_id") @db.Uuid

  // Quick rating
  rating FeedbackRating

  // Detailed feedback
  errorCategories String[]  @map("error_categories")
  missingContext  String?   @map("missing_context") @db.Text
  comment         String?   @db.Text

  // Quality scores (0-100)
  accuracyScore     Int? @map("accuracy_score")
  completenessScore Int? @map("completeness_score")
  styleMatchScore   Int? @map("style_match_score")

  // Output review
  reviewVerdict ReviewVerdict? @map("review_verdict")
  editDistance  Int?           @map("edit_distance") // 0-100 percentage
  outputIssues  String[]       @map("output_issues")

  submittedAt   DateTime @default(now()) @map("submitted_at")
  submittedById String   @map("submitted_by_id") @db.Uuid

  // Relations
  session     AISession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  submittedBy User      @relation(fields: [submittedById], references: [id])

  @@index([tenantId])
  @@index([rating])
  @@index([submittedAt])
  @@map("session_feedback")
}

enum FeedbackRating {
  POSITIVE
  NEGATIVE
  SKIPPED
}

model FeedbackMetrics {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  date        DateTime @db.Date

  // Session counts
  totalSessions    Int @default(0) @map("total_sessions")
  positiveRatings  Int @default(0) @map("positive_ratings")
  negativeRatings  Int @default(0) @map("negative_ratings")
  skippedRatings   Int @default(0) @map("skipped_ratings")

  // Rates
  firstPassAcceptanceRate Float? @map("first_pass_acceptance_rate")
  averageEditDistance     Float? @map("average_edit_distance")

  // Error distribution
  errorCategoryCounts Json @default("{}") @map("error_category_counts")

  // Quality averages
  avgAccuracyScore     Float? @map("avg_accuracy_score")
  avgCompletenessScore Float? @map("avg_completeness_score")
  avgStyleMatchScore   Float? @map("avg_style_match_score")

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([tenantId, workspaceId, date])
  @@index([tenantId])
  @@index([workspaceId])
  @@index([date])
  @@map("feedback_metrics_daily")
}

// ============================================================================
// INTEGRATIONS
// ============================================================================

model Integration {
  id          String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String          @map("tenant_id") @db.Uuid
  workspaceId String          @map("workspace_id") @db.Uuid
  provider    IntegrationProvider
  name        String          @db.VarChar(255)

  // OAuth credentials (encrypted at rest)
  /// @pii - Contains OAuth tokens
  credentials Json            @default("{}")

  // Sync configuration
  syncConfig  Json            @default("{}") @map("sync_config")

  // Status
  status      IntegrationStatus @default(PENDING)
  lastSyncAt  DateTime?       @map("last_sync_at")
  lastError   String?         @map("last_error") @db.Text

  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  syncJobs  SyncJob[]

  @@unique([workspaceId, provider])
  @@index([tenantId])
  @@map("integrations")
}

enum IntegrationProvider {
  GITHUB
  NOTION
  FIGMA
  SLACK
  CONFLUENCE
  LINEAR
}

enum IntegrationStatus {
  PENDING
  ACTIVE
  ERROR
  DISABLED
}

model SyncJob {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  integrationId String    @map("integration_id") @db.Uuid
  status        SyncJobStatus @default(PENDING)
  syncType      String    @map("sync_type") @db.VarChar(50) // 'full' or 'incremental'

  // Results
  itemsProcessed Int      @default(0) @map("items_processed")
  itemsFailed    Int      @default(0) @map("items_failed")
  errorLog       String?  @map("error_log") @db.Text

  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([status])
  @@map("sync_jobs")
}

enum SyncJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// ============================================================================
// AUTHENTICATION & SECURITY
// ============================================================================

model ApiKey {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  name        String    @db.VarChar(255)
  keyHash     String    @unique @map("key_hash") @db.VarChar(64)
  keyPrefix   String    @map("key_prefix") @db.VarChar(10) // For display (e.g., "cc_abc123...")
  permissions String[]  // Specific permissions for this key
  isActive    Boolean   @default(true) @map("is_active")
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyHash])
  @@map("api_keys")
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  timestamp    DateTime @default(now())

  // Actor
  actorId      String   @map("actor_id") @db.VarChar(255)
  actorType    String   @map("actor_type") @db.VarChar(50) // 'user', 'api_key', 'system'

  // Action
  action       String   @db.VarChar(100) // e.g., 'auth.login.success'

  // Resource
  resourceType String?  @map("resource_type") @db.VarChar(100)
  resourceId   String?  @map("resource_id") @db.VarChar(255)

  // Details
  metadata     Json     @default("{}")

  // Outcome
  outcome      String   @db.VarChar(20) // 'success', 'failure', 'denied'
  errorCode    String?  @map("error_code") @db.VarChar(50)
  errorMessage String?  @map("error_message") @db.Text

  // Request context
  ipAddress    String?  @map("ip_address") @db.VarChar(45) // IPv6 max length
  userAgent    String?  @map("user_agent") @db.VarChar(500)

  @@index([tenantId])
  @@index([timestamp])
  @@index([actorId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

// ============================================================================
// REACTIVE CONTEXT LAYER
// ============================================================================

model ContextEvent {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  graphId       String   @map("graph_id") @db.Uuid

  // Event type
  eventType     String   @map("event_type") @db.VarChar(100)
  entityType    String   @map("entity_type") @db.VarChar(50)
  entityId      String   @map("entity_id") @db.Uuid

  // Version tracking
  version       Int
  globalVersion BigInt   @map("global_version")
  vectorClock   Json     @map("vector_clock") @default("{}")

  // Actor
  actorId       String   @map("actor_id") @db.VarChar(255)
  actorType     String   @map("actor_type") @db.VarChar(50)

  // Payload
  payload       Json
  metadata      Json     @default("{}")

  timestamp     DateTime @default(now())

  // Relations
  graph         ContextGraph @relation(fields: [graphId], references: [id], onDelete: Cascade)

  @@index([tenantId, globalVersion])
  @@index([tenantId, graphId, entityType, entityId])
  @@index([tenantId, timestamp])
  @@index([graphId])
  @@map("context_events")
}

model EntityChange {
  id              String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String     @map("tenant_id") @db.Uuid

  // Entity reference
  entityType      String     @map("entity_type") @db.VarChar(100)
  entityId        String     @map("entity_id") @db.Uuid

  // Version info
  version         Int
  previousVersion Int?       @map("previous_version")

  // Change details
  changeType      ChangeType @map("change_type")
  changedFields   String[]   @map("changed_fields")
  previousValues  Json?      @map("previous_values")
  newValues       Json       @map("new_values")

  // Actor
  actorId         String     @map("actor_id") @db.VarChar(255)
  actorType       String     @map("actor_type") @db.VarChar(50)

  // Metadata
  metadata        Json       @default("{}")
  timestamp       DateTime   @default(now())

  // Event correlation
  eventId         String?    @map("event_id") @db.Uuid

  @@index([tenantId, entityType, entityId])
  @@index([tenantId, timestamp])
  @@index([tenantId, version])
  @@index([eventId])
  @@map("entity_changes")
}

enum ChangeType {
  CREATE
  UPDATE
  DELETE
  RESTORE
  ROLLBACK
}

model EntitySnapshot {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid

  entityType    String   @map("entity_type") @db.VarChar(100)
  entityId      String   @map("entity_id") @db.Uuid
  version       Int

  snapshot      Json
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([tenantId, entityType, entityId, version])
  @@index([tenantId, entityType, entityId])
  @@map("entity_snapshots")
}

model EntityDraft {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid

  // Source entity
  entityType    String    @map("entity_type") @db.VarChar(100)
  entityId      String    @map("entity_id") @db.Uuid
  baseVersion   Int       @map("base_version")

  // Draft content
  draftContent  Json      @map("draft_content")
  changedFields String[]  @map("changed_fields")

  // Metadata
  name          String?   @db.VarChar(255)
  createdById   String    @map("created_by_id") @db.Uuid
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  expiresAt     DateTime? @map("expires_at")

  @@unique([tenantId, entityType, entityId, createdById])
  @@index([tenantId, createdById])
  @@index([expiresAt])
  @@map("entity_drafts")
}

model EntityVersion {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  entityType    String   @map("entity_type") @db.VarChar(50)
  entityId      String   @map("entity_id") @db.Uuid

  version       Int      @default(1)
  vectorClock   Json     @map("vector_clock") @default("{}")

  lastEventId   String?  @map("last_event_id") @db.Uuid
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, entityType, entityId])
  @@map("entity_versions")
}

// ============================================================================
// SUBSCRIPTION SYSTEM
// ============================================================================

model ContextSubscription {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  clientId    String   @map("client_id") @db.VarChar(255)

  // Product info
  product     String   @db.VarChar(50) // 'chat', 'code', 'cowork'
  productVersion String @map("product_version") @db.VarChar(50)

  // Subscription scopes
  scopes      Json     // SubscriptionScope[]
  filters     Json?    // Optional filters
  options     Json     // Delivery options

  // State
  lastVersion BigInt?  @map("last_version")
  lastAckAt   DateTime? @map("last_ack_at")
  isActive    Boolean  @default(true) @map("is_active")

  createdAt   DateTime @default(now()) @map("created_at")
  expiresAt   DateTime @map("expires_at")

  @@index([tenantId, clientId])
  @@index([tenantId, product])
  @@index([isActive])
  @@index([expiresAt])
  @@map("context_subscriptions")
}

model PendingDelivery {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  subscriptionId  String   @map("subscription_id") @db.Uuid
  eventId         String   @map("event_id") @db.Uuid

  payload         Json
  attempts        Int      @default(0)
  lastAttemptAt   DateTime? @map("last_attempt_at")
  nextAttemptAt   DateTime  @map("next_attempt_at")

  createdAt       DateTime @default(now()) @map("created_at")

  @@index([subscriptionId])
  @@index([nextAttemptAt])
  @@map("pending_deliveries")
}

// Global version counter per tenant
model TenantVersion {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @unique @map("tenant_id") @db.Uuid
  globalVersion BigInt   @default(0) @map("global_version")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("tenant_versions")
}
